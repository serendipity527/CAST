æˆ‘éœ€è¦åˆ†æè¿™äº›æ–‡ä»¶æ¥ç”Ÿæˆè¯¦ç»†çš„æ¨¡å‹æ¶æ„å›¾ã€‚è®©æˆ‘å…ˆåˆ›å»ºä¸€ä¸ªä»»åŠ¡è®¡åˆ’ï¼Œç„¶åé€ä¸ªè¯»å–è¿™äº›æ–‡ä»¶æ¥ç†è§£æ¨¡å‹æ¶æ„ã€‚

è®©æˆ‘å¼€å§‹è¯»å–è¿™äº›æ–‡ä»¶æ¥ç†è§£æ¨¡å‹æ¶æ„ã€‚

è®©æˆ‘ç»§ç»­è¯»å–å…¶ä»–å±‚æ–‡ä»¶æ¥ç†è§£å®Œæ•´çš„æ¨¡å‹æ¶æ„ã€‚

è®©æˆ‘ç»§ç»­è¯»å–å‰©ä½™çš„æ–‡ä»¶æ¥å®Œæˆæ¨¡å‹æ¶æ„çš„åˆ†æã€‚

ç°åœ¨æˆ‘å·²ç»è¯»å–äº†æ‰€æœ‰ç›¸å…³æ–‡ä»¶ï¼Œè®©æˆ‘æ›´æ–°ä»»åŠ¡çŠ¶æ€å¹¶å¼€å§‹åˆ†ææ¨¡å‹æ¶æ„ã€‚

åŸºäºå¯¹æ‰€æœ‰æ–‡ä»¶çš„åˆ†æï¼Œæˆ‘ç°åœ¨æ¥ç”Ÿæˆè¯¦ç»†çš„æ¨¡å‹æ¶æ„å›¾ã€‚è®©æˆ‘å…ˆå®Œæˆæ•°æ®æµåˆ†æï¼Œç„¶åç”Ÿæˆ Mermaid æ¶æ„å›¾ã€‚

åŸºäºå¯¹æ‰€æœ‰æ–‡ä»¶çš„æ·±å…¥åˆ†æï¼Œæˆ‘ç°åœ¨ç”Ÿæˆè¯¦ç»†çš„ CAST æ¨¡å‹æ¶æ„å›¾ã€‚è¿™ä¸ªæ¨¡å‹æ˜¯ä¸€ä¸ªåŸºäº TimeLLM çš„æ—¶é—´åºåˆ—é¢„æµ‹æ¨¡å‹ï¼Œé›†æˆäº†å¤šç§å…ˆè¿›çš„ç»„ä»¶ã€‚

```mermaid
graph TB
    %% è¾“å…¥æ•°æ®æµ
    subgraph "è¾“å…¥å±‚ Input Layer"
        A[æ—¶é—´åºåˆ—æ•°æ®<br/>x_enc: BÃ—TÃ—N] --> B[æ•°æ®æ ‡å‡†åŒ–<br/>Normalize Layer]
        A1[æ—¶é—´æ ‡è®°<br/>x_mark_enc] 
    end

    %% Patch Embedding åˆ†æ”¯é€‰æ‹©
    subgraph "Patch Embedding å±‚"
        B --> C{Patch Embedding<br/>æ¨¡å¼é€‰æ‹©}
        
        %% ä¸‰ç§ Embedding é€‰é¡¹
        C -->|wavelet_mode='none'| D[PatchEmbedding<br/>åŸç‰ˆæ–¹æ¡ˆ]
        C -->|wavelet_mode='haar'| E[WaveletPatchEmbedding<br/>Haarå°æ³¢æ–¹æ¡ˆ]
        C -->|wavelet_mode='wist'| F[WISTPatchEmbedding<br/>WIST-PEæ–¹æ¡ˆ]
        
        %% PatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "PatchEmbedding åŸç‰ˆ"
            D --> D1[ReplicationPad1d<br/>è¾¹ç•Œå¡«å……]
            D1 --> D2[Unfoldæ“ä½œ<br/>åˆ‡åˆ†Patch]
            D2 --> D3[TokenEmbedding<br/>Conv1dæŠ•å½±]
            D3 --> D4[Dropout]
        end
        
        %% WaveletPatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "WaveletPatchEmbedding Haaræ–¹æ¡ˆ"
            E --> E1[ReplicationPad1d<br/>è¾¹ç•Œå¡«å……]
            E1 --> E2[Unfoldæ“ä½œ<br/>åˆ‡åˆ†Patch]
            E2 --> E3[Haar DWTåˆ†è§£<br/>ä½é¢‘+é«˜é¢‘]
            E3 --> E4[åŒé€šé“æŠ•å½±<br/>Approx+Detail Embedding]
            E4 --> E5[SoftThreshold<br/>å¯é€‰å»å™ª]
            E5 --> E6[é—¨æ§èåˆ<br/>Gate Mechanism]
            E6 --> E7[Detail Dropout<br/>p=0.5]
        end
        
        %% WISTPatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "WISTPatchEmbedding WIST-PEæ–¹æ¡ˆ"
            F --> F1[å› æœå°æ³¢åˆ†è§£<br/>CausalSWT]
            
            subgraph "CausalSWT å› æœå°æ³¢å˜æ¢"
                F1 --> F1a[å¤šçº§å°æ³¢åˆ†è§£<br/>db4/haar, Level 1-3]
                F1a --> F1b[å› æœå·ç§¯<br/>ä»…ä½¿ç”¨è¿‡å»æ•°æ®]
                F1b --> F1c[è¾“å‡ºå¤šé¢‘æ®µç³»æ•°<br/>cA_n, cD_n...cD_1]
            end
            
            F1c --> F2[å¤šé¢‘æ®µç‹¬ç«‹æŠ•å½±<br/>æ¯ä¸ªé¢‘æ®µå•ç‹¬Embedding]
            F2 --> F3[é¢‘ç‡é€šé“æ³¨æ„åŠ›<br/>FrequencyChannelAttention]
            
            subgraph "é¢‘ç‡æ³¨æ„åŠ›æœºåˆ¶"
                F3 --> F3a{æ³¨æ„åŠ›ç‰ˆæœ¬é€‰æ‹©}
                F3a -->|V1| F3b[Global Average Pooling<br/>Instance-wiseæƒé‡]
                F3a -->|V2| F3c[1D Convå±€éƒ¨ä¸Šä¸‹æ–‡<br/>Patch-wiseæƒé‡]
                F3a -->|V3| F3d[Global-LocalåŒæµèåˆ<br/>å¯å­¦ä¹ Î±æƒé‡]
            end
            
            F3 --> F4[è½¯é˜ˆå€¼å»å™ª<br/>SoftThreshold]
            F4 --> F5[åˆ†å±‚é‡‘å­—å¡”èåˆ<br/>Pyramid Fusion]
            F5 --> F6[å› æœå·ç§¯å¢å¼º<br/>CausalConv1d]
            F6 --> F7[å¤šå±‚Dropout<br/>HF/MFæ­£åˆ™åŒ–]
        end
    end

    %% ç»Ÿè®¡ç‰¹å¾æå–
    subgraph "ç»Ÿè®¡ç‰¹å¾æå–"
        B --> G[ç»Ÿè®¡é‡è®¡ç®—<br/>min/max/median/trend/lags]
        G --> H[Promptæ„å»º<br/>è‡ªç„¶è¯­è¨€æè¿°]
    end

    %% LLM ä¸»å¹²ç½‘ç»œ
    subgraph "LLM ä¸»å¹²ç½‘ç»œ"
        H --> I[Tokenizer<br/>æ–‡æœ¬ç¼–ç ]
        I --> J[LLM Input Embeddings<br/>PromptåµŒå…¥]
        
        %% Patch Embedding è¾“å‡ºæ±‡èš
        D4 --> K[ReprogrammingLayer<br/>è·¨æ¨¡æ€å¯¹é½]
        E7 --> K
        F7 --> K
        
        K --> L[Word Embeddings<br/>æ˜ å°„å±‚]
        L --> M[LLM Backbone<br/>LLAMA/GPT2/BERT]
        J --> N[Prompt + Patchæ‹¼æ¥]
        M --> N
        
        subgraph "LLM å†…éƒ¨ç»“æ„"
            N --> N1[Multi-Head Attention<br/>è‡ªæ³¨æ„åŠ›æœºåˆ¶]
            N1 --> N2[Feed Forward Network<br/>å‰é¦ˆç½‘ç»œ]
            N2 --> N3[Layer Normalization<br/>å±‚å½’ä¸€åŒ–]
            N3 --> N4[Dropoutæ­£åˆ™åŒ–]
        end
        
        N4 --> O[LLM Hidden States<br/>éšè—çŠ¶æ€è¾“å‡º]
    end

    %% è¾“å‡ºå¤´é€‰æ‹©
    subgraph "è¾“å‡ºæŠ•å½±å±‚ Output Projection"
        O --> P{è¾“å‡ºå¤´é€‰æ‹©}
        
        %% ä¸‰ç§è¾“å‡ºå¤´é€‰é¡¹
        P -->|use_dual_scale_head=1| Q[DualScaleResidualHead<br/>åŒå°ºåº¦æ®‹å·®å¤´]
        P -->|use_freq_decoupled_head=1| R[TriBandDecoupledHead<br/>ä¸‰é¢‘å¸¦è§£è€¦å¤´]
        P -->|é»˜è®¤| S[FlattenHead<br/>åŸç‰ˆè¾“å‡ºå¤´]
        
        %% DualScaleResidualHead è¯¦ç»†ç»“æ„
        subgraph "DualScaleResidualHead åŒå°ºåº¦æ®‹å·®"
            Q --> Q1[Global Average Pooling<br/>å…¨å±€è¶‹åŠ¿åˆ†æ”¯]
            Q --> Q2[Flattenæ“ä½œ<br/>å±€éƒ¨ç»†èŠ‚åˆ†æ”¯]
            Q1 --> Q3[LinearæŠ•å½±<br/>Trendé¢„æµ‹]
            Q2 --> Q4[LinearæŠ•å½±<br/>Detailé¢„æµ‹]
            Q3 --> Q5[æ®‹å·®ç›¸åŠ <br/>Final = Trend + Detail]
            Q4 --> Q5
            Q5 --> Q6[Dropout + Permute<br/>è¾“å‡ºæ ¼å¼è°ƒæ•´]
        end
        
        %% TriBandDecoupledHead è¯¦ç»†ç»“æ„
        subgraph "TriBandDecoupledHead ä¸‰é¢‘å¸¦è§£è€¦"
            R --> R1[Flattenå±•å¹³<br/>ç‰¹å¾å‘é‡åŒ–]
            R1 --> R2[Head1: ä½é¢‘è¶‹åŠ¿<br/>Linearæ— æ­£åˆ™]
            R1 --> R3[Head2: ä¸­é¢‘åˆ†é‡<br/>Linear + Dropout]
            R1 --> R4[Head3: é«˜é¢‘ç»†èŠ‚<br/>Linear + SoftThreshold + å¼ºDropout]
            
            subgraph "é«˜é¢‘ç»†èŠ‚å¤„ç†"
                R4 --> R4a[æŠ•å½±åˆ°éšå±‚<br/>é™ç»´å¤„ç†]
                R4a --> R4b[SoftThresholdå»å™ª<br/>å¯å­¦ä¹ é˜ˆå€¼]
                R4b --> R4c[å¼ºDropoutæ­£åˆ™<br/>p=0.5]
                R4c --> R4d[é‡æ„åˆ°æ—¶åŸŸ<br/>LinearæŠ•å½±]
            end
            
            R2 --> R5[æ—¶åŸŸç›´æ¥ç›¸åŠ <br/>Trend + Mid + Detail]
            R3 --> R5
            R4d --> R5
            R5 --> R6[è¾“å‡ºDropout + Permute<br/>æ ¼å¼è°ƒæ•´]
        end
        
        %% FlattenHead è¯¦ç»†ç»“æ„
        subgraph "FlattenHead åŸç‰ˆ"
            S --> S1[Flattenå±•å¹³<br/>ç‰¹å¾å‘é‡åŒ–]
            S1 --> S2[LinearæŠ•å½±<br/>æ—¶åŸŸé¢„æµ‹]
            S2 --> S3[Dropout + Permute<br/>è¾“å‡ºæ ¼å¼è°ƒæ•´]
        end
    end

    %% è¾“å‡ºå¤„ç†
    subgraph "è¾“å‡ºå¤„ç†å±‚"
        Q6 --> T[åæ ‡å‡†åŒ–<br/>Denormalize]
        R6 --> T
        S3 --> T
        T --> U[æœ€ç»ˆé¢„æµ‹è¾“å‡º<br/>BÃ—pred_lenÃ—N]
    end

    %% æ·±åº¦ç›‘ç£åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
    subgraph "æ·±åº¦ç›‘ç£è®­ç»ƒ (å¯é€‰)"
        R6 -.->|return_components=True| V[é¢‘ç‡åˆ†é‡è¾“å‡º<br/>Trend/Mid/Detail]
        V -.-> W[DeepSupervisionLoss<br/>è¾…åŠ©æŸå¤±è®¡ç®—]
        U -.-> X[ä¸»æŸå¤±<br/>MSE Loss]
        W -.-> Y[æ€»æŸå¤±<br/>Main + Î±Ã—Aux]
        X -.-> Y
    end

    %% è¾…åŠ©ç»„ä»¶
    subgraph "è¾…åŠ©ç»„ä»¶ Auxiliary Components"
        Z1[AutoCorrelation<br/>è‡ªç›¸å…³æ³¨æ„åŠ›]
        Z2[Autoformer_EncDec<br/>åˆ†è§£æ¶æ„ç»„ä»¶]
        Z3[Conv_Blocks<br/>Inceptionå·ç§¯å—]
        Z4[SelfAttention_Family<br/>å¤šç§æ³¨æ„åŠ›æœºåˆ¶]
        Z5[Transformer_EncDec<br/>æ ‡å‡†Transformerç»„ä»¶]
    end

    %% æ ·å¼å®šä¹‰
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef embeddingStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef llmStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef outputStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef auxStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class A,A1,B inputStyle
    class C,D,E,F,D1,D2,D3,D4,E1,E2,E3,E4,E5,E6,E7,F1,F2,F3,F4,F5,F6,F7 embeddingStyle
    class G,H,I,J,K,L,M,N,N1,N2,N3,N4,O llmStyle
    class P,Q,R,S,Q1,Q2,Q3,Q4,Q5,Q6,R1,R2,R3,R4,R5,R6,S1,S2,S3,T,U outputStyle
    class V,W,X,Y,Z1,Z2,Z3,Z4,Z5 auxStyle
```

## CAST æ¨¡å‹è¯¦ç»†æ¶æ„å›¾

åŸºäºå¯¹æ‰€æœ‰æ–‡ä»¶çš„æ·±å…¥åˆ†æï¼Œæˆ‘å·²ç»ç”Ÿæˆäº†å®Œæ•´çš„ CAST æ¨¡å‹æ¶æ„å›¾ã€‚è¿™æ˜¯ä¸€ä¸ªåŸºäº TimeLLM çš„å…ˆè¿›æ—¶é—´åºåˆ—é¢„æµ‹æ¨¡å‹ï¼Œé›†æˆäº†å¤šç§åˆ›æ–°ç»„ä»¶ï¼š

### ğŸ—ï¸ **æ¨¡å‹æ•´ä½“æ¶æ„**

```mermaid
graph TB
    %% è¾“å…¥æ•°æ®æµ
    subgraph "è¾“å…¥å±‚ Input Layer"
        A[æ—¶é—´åºåˆ—æ•°æ®<br/>x_enc: BÃ—TÃ—N] --> B[æ•°æ®æ ‡å‡†åŒ–<br/>Normalize Layer]
        A1[æ—¶é—´æ ‡è®°<br/>x_mark_enc] 
    end

    %% Patch Embedding åˆ†æ”¯é€‰æ‹©
    subgraph "Patch Embedding å±‚"
        B --> C{Patch Embedding<br/>æ¨¡å¼é€‰æ‹©}
        
        %% ä¸‰ç§ Embedding é€‰é¡¹
        C -->|wavelet_mode='none'| D[PatchEmbedding<br/>åŸç‰ˆæ–¹æ¡ˆ]
        C -->|wavelet_mode='haar'| E[WaveletPatchEmbedding<br/>Haarå°æ³¢æ–¹æ¡ˆ]
        C -->|wavelet_mode='wist'| F[WISTPatchEmbedding<br/>WIST-PEæ–¹æ¡ˆ]
        
        %% PatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "PatchEmbedding åŸç‰ˆ"
            D --> D1[ReplicationPad1d<br/>è¾¹ç•Œå¡«å……]
            D1 --> D2[Unfoldæ“ä½œ<br/>åˆ‡åˆ†Patch]
            D2 --> D3[TokenEmbedding<br/>Conv1dæŠ•å½±]
            D3 --> D4[Dropout]
        end
        
        %% WaveletPatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "WaveletPatchEmbedding Haaræ–¹æ¡ˆ"
            E --> E1[ReplicationPad1d<br/>è¾¹ç•Œå¡«å……]
            E1 --> E2[Unfoldæ“ä½œ<br/>åˆ‡åˆ†Patch]
            E2 --> E3[Haar DWTåˆ†è§£<br/>ä½é¢‘+é«˜é¢‘]
            E3 --> E4[åŒé€šé“æŠ•å½±<br/>Approx+Detail Embedding]
            E4 --> E5[SoftThreshold<br/>å¯é€‰å»å™ª]
            E5 --> E6[é—¨æ§èåˆ<br/>Gate Mechanism]
            E6 --> E7[Detail Dropout<br/>p=0.5]
        end
        
        %% WISTPatchEmbedding è¯¦ç»†ç»“æ„
        subgraph "WISTPatchEmbedding WIST-PEæ–¹æ¡ˆ"
            F --> F1[å› æœå°æ³¢åˆ†è§£<br/>CausalSWT]
            
            subgraph "CausalSWT å› æœå°æ³¢å˜æ¢"
                F1 --> F1a[å¤šçº§å°æ³¢åˆ†è§£<br/>db4/haar, Level 1-3]
                F1a --> F1b[å› æœå·ç§¯<br/>ä»…ä½¿ç”¨è¿‡å»æ•°æ®]
                F1b --> F1c[è¾“å‡ºå¤šé¢‘æ®µç³»æ•°<br/>cA_n, cD_n...cD_1]
            end
            
            F1c --> F2[å¤šé¢‘æ®µç‹¬ç«‹æŠ•å½±<br/>æ¯ä¸ªé¢‘æ®µå•ç‹¬Embedding]
            F2 --> F3[é¢‘ç‡é€šé“æ³¨æ„åŠ›<br/>FrequencyChannelAttention]
            
            subgraph "é¢‘ç‡æ³¨æ„åŠ›æœºåˆ¶"
                F3 --> F3a{æ³¨æ„åŠ›ç‰ˆæœ¬é€‰æ‹©}
                F3a -->|V1| F3b[Global Average Pooling<br/>Instance-wiseæƒé‡]
                F3a -->|V2| F3c[1D Convå±€éƒ¨ä¸Šä¸‹æ–‡<br/>Patch-wiseæƒé‡]
                F3a -->|V3| F3d[Global-LocalåŒæµèåˆ<br/>å¯å­¦ä¹ Î±æƒé‡]
            end
            
            F3 --> F4[è½¯é˜ˆå€¼å»å™ª<br/>SoftThreshold]
            F4 --> F5[åˆ†å±‚é‡‘å­—å¡”èåˆ<br/>Pyramid Fusion]
            F5 --> F6[å› æœå·ç§¯å¢å¼º<br/>CausalConv1d]
            F6 --> F7[å¤šå±‚Dropout<br/>HF/MFæ­£åˆ™åŒ–]
        end
    end

    %% ç»Ÿè®¡ç‰¹å¾æå–
    subgraph "ç»Ÿè®¡ç‰¹å¾æå–"
        B --> G[ç»Ÿè®¡é‡è®¡ç®—<br/>min/max/median/trend/lags]
        G --> H[Promptæ„å»º<br/>è‡ªç„¶è¯­è¨€æè¿°]
    end

    %% LLM ä¸»å¹²ç½‘ç»œ
    subgraph "LLM ä¸»å¹²ç½‘ç»œ"
        H --> I[Tokenizer<br/>æ–‡æœ¬ç¼–ç ]
        I --> J[LLM Input Embeddings<br/>PromptåµŒå…¥]
        
        %% Patch Embedding è¾“å‡ºæ±‡èš
        D4 --> K[ReprogrammingLayer<br/>è·¨æ¨¡æ€å¯¹é½]
        E7 --> K
        F7 --> K
        
        K --> L[Word Embeddings<br/>æ˜ å°„å±‚]
        L --> M[LLM Backbone<br/>LLAMA/GPT2/BERT]
        J --> N[Prompt + Patchæ‹¼æ¥]
        M --> N
        
        subgraph "LLM å†…éƒ¨ç»“æ„"
            N --> N1[Multi-Head Attention<br/>è‡ªæ³¨æ„åŠ›æœºåˆ¶]
            N1 --> N2[Feed Forward Network<br/>å‰é¦ˆç½‘ç»œ]
            N2 --> N3[Layer Normalization<br/>å±‚å½’ä¸€åŒ–]
            N3 --> N4[Dropoutæ­£åˆ™åŒ–]
        end
        
        N4 --> O[LLM Hidden States<br/>éšè—çŠ¶æ€è¾“å‡º]
    end

    %% è¾“å‡ºå¤´é€‰æ‹©
    subgraph "è¾“å‡ºæŠ•å½±å±‚ Output Projection"
        O --> P{è¾“å‡ºå¤´é€‰æ‹©}
        
        %% ä¸‰ç§è¾“å‡ºå¤´é€‰é¡¹
        P -->|use_dual_scale_head=1| Q[DualScaleResidualHead<br/>åŒå°ºåº¦æ®‹å·®å¤´]
        P -->|use_freq_decoupled_head=1| R[TriBandDecoupledHead<br/>ä¸‰é¢‘å¸¦è§£è€¦å¤´]
        P -->|é»˜è®¤| S[FlattenHead<br/>åŸç‰ˆè¾“å‡ºå¤´]
        
        %% DualScaleResidualHead è¯¦ç»†ç»“æ„
        subgraph "DualScaleResidualHead åŒå°ºåº¦æ®‹å·®"
            Q --> Q1[Global Average Pooling<br/>å…¨å±€è¶‹åŠ¿åˆ†æ”¯]
            Q --> Q2[Flattenæ“ä½œ<br/>å±€éƒ¨ç»†èŠ‚åˆ†æ”¯]
            Q1 --> Q3[LinearæŠ•å½±<br/>Trendé¢„æµ‹]
            Q2 --> Q4[LinearæŠ•å½±<br/>Detailé¢„æµ‹]
            Q3 --> Q5[æ®‹å·®ç›¸åŠ <br/>Final = Trend + Detail]
            Q4 --> Q5
            Q5 --> Q6[Dropout + Permute<br/>è¾“å‡ºæ ¼å¼è°ƒæ•´]
        end
        
        %% TriBandDecoupledHead è¯¦ç»†ç»“æ„
        subgraph "TriBandDecoupledHead ä¸‰é¢‘å¸¦è§£è€¦"
            R --> R1[Flattenå±•å¹³<br/>ç‰¹å¾å‘é‡åŒ–]
            R1 --> R2[Head1: ä½é¢‘è¶‹åŠ¿<br/>Linearæ— æ­£åˆ™]
            R1 --> R3[Head2: ä¸­é¢‘åˆ†é‡<br/>Linear + Dropout]
            R1 --> R4[Head3: é«˜é¢‘ç»†èŠ‚<br/>Linear + SoftThreshold + å¼ºDropout]
            
            subgraph "é«˜é¢‘ç»†èŠ‚å¤„ç†"
                R4 --> R4a[æŠ•å½±åˆ°éšå±‚<br/>é™ç»´å¤„ç†]
                R4a --> R4b[SoftThresholdå»å™ª<br/>å¯å­¦ä¹ é˜ˆå€¼]
                R4b --> R4c[å¼ºDropoutæ­£åˆ™<br/>p=0.5]
                R4c --> R4d[é‡æ„åˆ°æ—¶åŸŸ<br/>LinearæŠ•å½±]
            end
            
            R2 --> R5[æ—¶åŸŸç›´æ¥ç›¸åŠ <br/>Trend + Mid + Detail]
            R3 --> R5
            R4d --> R5
            R5 --> R6[è¾“å‡ºDropout + Permute<br/>æ ¼å¼è°ƒæ•´]
        end
        
        %% FlattenHead è¯¦ç»†ç»“æ„
        subgraph "FlattenHead åŸç‰ˆ"
            S --> S1[Flattenå±•å¹³<br/>ç‰¹å¾å‘é‡åŒ–]
            S1 --> S2[LinearæŠ•å½±<br/>æ—¶åŸŸé¢„æµ‹]
            S2 --> S3[Dropout + Permute<br/>è¾“å‡ºæ ¼å¼è°ƒæ•´]
        end
    end

    %% è¾“å‡ºå¤„ç†
    subgraph "è¾“å‡ºå¤„ç†å±‚"
        Q6 --> T[åæ ‡å‡†åŒ–<br/>Denormalize]
        R6 --> T
        S3 --> T
        T --> U[æœ€ç»ˆé¢„æµ‹è¾“å‡º<br/>BÃ—pred_lenÃ—N]
    end

    %% æ·±åº¦ç›‘ç£åˆ†æ”¯ï¼ˆå¯é€‰ï¼‰
    subgraph "æ·±åº¦ç›‘ç£è®­ç»ƒ (å¯é€‰)"
        R6 -.->|return_components=True| V[é¢‘ç‡åˆ†é‡è¾“å‡º<br/>Trend/Mid/Detail]
        V -.-> W[DeepSupervisionLoss<br/>è¾…åŠ©æŸå¤±è®¡ç®—]
        U -.-> X[ä¸»æŸå¤±<br/>MSE Loss]
        W -.-> Y[æ€»æŸå¤±<br/>Main + Î±Ã—Aux]
        X -.-> Y
    end

    %% è¾…åŠ©ç»„ä»¶
    subgraph "è¾…åŠ©ç»„ä»¶ Auxiliary Components"
        Z1[AutoCorrelation<br/>è‡ªç›¸å…³æ³¨æ„åŠ›]
        Z2[Autoformer_EncDec<br/>åˆ†è§£æ¶æ„ç»„ä»¶]
        Z3[Conv_Blocks<br/>Inceptionå·ç§¯å—]
        Z4[SelfAttention_Family<br/>å¤šç§æ³¨æ„åŠ›æœºåˆ¶]
        Z5[Transformer_EncDec<br/>æ ‡å‡†Transformerç»„ä»¶]
    end

    %% æ ·å¼å®šä¹‰
    classDef inputStyle fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef embeddingStyle fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef llmStyle fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef outputStyle fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef auxStyle fill:#fce4ec,stroke:#880e4f,stroke-width:2px

    class A,A1,B inputStyle
    class C,D,E,F,D1,D2,D3,D4,E1,E2,E3,E4,E5,E6,E7,F1,F2,F3,F4,F5,F6,F7 embeddingStyle
    class G,H,I,J,K,L,M,N,N1,N2,N3,N4,O llmStyle
    class P,Q,R,S,Q1,Q2,Q3,Q4,Q5,Q6,R1,R2,R3,R4,R5,R6,S1,S2,S3,T,U outputStyle
    class V,W,X,Y,Z1,Z2,Z3,Z4,Z5 auxStyle
```

### ğŸ“‹ **æ ¸å¿ƒç»„ä»¶è¯´æ˜**

#### **1. è¾“å…¥å¤„ç†å±‚**
- **æ•°æ®æ ‡å‡†åŒ–**: ä½¿ç”¨ [Normalize](cci:2://file:///home/dmx_MT/LZF/project/CAST/layers/StandardNorm.py:4:0-67:16) å±‚è¿›è¡Œ RevIN æ ‡å‡†åŒ–
- **ç»Ÿè®¡ç‰¹å¾æå–**: è®¡ç®— min/max/median/trend/lags ç­‰ç»Ÿè®¡é‡
- **Prompt æ„å»º**: å°†ç»Ÿè®¡ä¿¡æ¯è½¬æ¢ä¸ºè‡ªç„¶è¯­è¨€æè¿°

#### **2. Patch Embedding å±‚ï¼ˆä¸‰ç§æ–¹æ¡ˆï¼‰**

**ğŸ”¹ åŸç‰ˆ PatchEmbedding**
- æ ‡å‡†çš„æ—¶é—´åºåˆ—åˆ†å—åµŒå…¥
- ReplicationPad1d â†’ Unfold â†’ TokenEmbedding â†’ Dropout

**ğŸ”¹ WaveletPatchEmbedding (Haaræ–¹æ¡ˆ)**
- Haar å°æ³¢åˆ†è§£æ¯ä¸ª Patch
- åŒé€šé“ç‹¬ç«‹æŠ•å½±ï¼ˆä½é¢‘+é«˜é¢‘ï¼‰
- é—¨æ§èåˆæœºåˆ¶ï¼Œåå‘ä½é¢‘è¶‹åŠ¿
- é«˜é¢‘é€šé“å¼º Dropout (p=0.5) é˜²è¿‡æ‹Ÿåˆ

**ğŸ”¹ WISTPatchEmbedding (WIST-PEæ–¹æ¡ˆ)**
- **å› æœå°æ³¢å˜æ¢**: ä½¿ç”¨ [CausalSWT](cci:2://file:///home/dmx_MT/LZF/project/CAST/layers/CausalWavelet.py:106:0-245:21) è¿›è¡Œå…¨å±€å¤šçº§åˆ†è§£
- **å¤šé¢‘æ®µå¤„ç†**: æ¯ä¸ªé¢‘æ®µç‹¬ç«‹åµŒå…¥æŠ•å½±
- **é¢‘ç‡é€šé“æ³¨æ„åŠ›**: ä¸‰ä¸ªç‰ˆæœ¬å¯é€‰
  - V1: Global Average Pooling (Instance-wise)
  - V2: 1D Conv å±€éƒ¨ä¸Šä¸‹æ–‡ (Patch-wise)  
  - V3: Global-Local åŒæµèåˆ
- **åˆ†å±‚é‡‘å­—å¡”èåˆ**: å¤šçº§åˆ†è§£çš„å±‚æ¬¡åŒ–èåˆ
- **å› æœå·ç§¯å¢å¼º**: ä¿æŒæ—¶åºå› æœæ€§

#### **3. LLM ä¸»å¹²ç½‘ç»œ**
- **è·¨æ¨¡æ€å¯¹é½**: [ReprogrammingLayer](cci:2://file:///home/dmx_MT/LZF/project/CAST/models/TimeLLM.py:367:0-405:38) å°†æ—¶åºç‰¹å¾å¯¹é½åˆ° LLM ç©ºé—´
- **LLM é€‰æ‹©**: æ”¯æŒ LLAMA/GPT2/BERT ä¸‰ç§é¢„è®­ç»ƒæ¨¡å‹
- **Prompt èåˆ**: è‡ªç„¶è¯­è¨€æè¿°ä¸æ—¶åºåµŒå…¥æ‹¼æ¥
- **å†»ç»“å‚æ•°**: LLM å‚æ•°å†»ç»“ï¼Œä»…è®­ç»ƒå¯¹é½å±‚å’Œè¾“å‡ºå¤´

#### **4. è¾“å‡ºæŠ•å½±å±‚ï¼ˆä¸‰ç§æ–¹æ¡ˆï¼‰**

**ğŸ”¹ FlattenHead (åŸç‰ˆ)**
- ç®€å•çš„ Flatten + Linear æŠ•å½±

**ğŸ”¹ DualScaleResidualHead (åŒå°ºåº¦æ®‹å·®)**
- **å…¨å±€è¶‹åŠ¿åˆ†æ”¯**: GAP â†’ Linear (æ•è·æ•´ä½“æ°´ä½)
- **å±€éƒ¨ç»†èŠ‚åˆ†æ”¯**: Flatten â†’ Linear (æ•è·æ—¶åºæ³¢åŠ¨)
- **æ®‹å·®èåˆ**: Trend + Detailï¼Œåˆ©ç”¨æ®‹å·®å­¦ä¹ 

**ğŸ”¹ TriBandDecoupledHead (ä¸‰é¢‘å¸¦è§£è€¦)**
- **ä½é¢‘å¤´**: æ— æ­£åˆ™åŒ–ï¼Œå­¦ä¹ ä¸»è¦è¶‹åŠ¿
- **ä¸­é¢‘å¤´**: è½»åº¦ Dropoutï¼Œå­¦ä¹ å‘¨æœŸæ€§æ¨¡å¼
- **é«˜é¢‘å¤´**: SoftThreshold + å¼º Dropoutï¼Œå­¦ä¹ ç»†èŠ‚æ³¢åŠ¨
- **æ—¶åŸŸé‡æ„**: ä¸‰ä¸ªåˆ†é‡ç›´æ¥ç›¸åŠ 
- **æ·±åº¦ç›‘ç£**: å¯é€‰çš„é¢‘ç‡åˆ†é‡è¾…åŠ©æŸå¤±

#### **5. è¾…åŠ©ç»„ä»¶**
- **AutoCorrelation**: è‡ªç›¸å…³æ³¨æ„åŠ›æœºåˆ¶
- **Autoformer_EncDec**: åºåˆ—åˆ†è§£æ¶æ„ç»„ä»¶
- **Conv_Blocks**: Inception å·ç§¯å—
- **SelfAttention_Family**: å¤šç§æ³¨æ„åŠ›æœºåˆ¶ (Full/Prob/DS/Reformer)
- **Transformer_EncDec**: æ ‡å‡† Transformer ç¼–è§£ç å™¨

### ğŸ¯ **æ¨¡å‹åˆ›æ–°ç‚¹**

1. **WIST-PE å› æœå°æ³¢åµŒå…¥**: å…¨å±€å¤šçº§å°æ³¢åˆ†è§£ + å› æœæ€§ä¿è¯
2. **é¢‘ç‡é€šé“æ³¨æ„åŠ›**: åŠ¨æ€é¢‘ç‡æƒé‡åˆ†é…ï¼Œè‡ªé€‚åº”é¢‘åŸŸèåˆ
3. **ä¸‰é¢‘å¸¦è§£è€¦è¾“å‡º**: æ˜¾å¼å»ºæ¨¡ä½/ä¸­/é«˜é¢‘åˆ†é‡ï¼Œæå‡é¢„æµ‹ç²¾åº¦
4. **æ·±åº¦ç›‘ç£è®­ç»ƒ**: ä½¿ç”¨å°æ³¢åˆ†è§£çš„ Ground Truth æŒ‡å¯¼è®­ç»ƒ
5. **è·¨æ¨¡æ€å¯¹é½**: æ—¶åºç‰¹å¾ä¸ LLM è¯­ä¹‰ç©ºé—´çš„æœ‰æ•ˆå¯¹é½

è¿™ä¸ªæ¶æ„å›¾å®Œæ•´å±•ç°äº† CAST æ¨¡å‹çš„å¤æ‚æ€§å’Œå…ˆè¿›æ€§ï¼Œç‰¹åˆ«æ˜¯åœ¨å°æ³¢å˜æ¢ã€é¢‘ç‡è§£è€¦å’Œå› æœæ€§ä¿è¯æ–¹é¢çš„åˆ›æ–°è®¾è®¡ã€‚