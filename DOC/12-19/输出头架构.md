graph TB
    %% 输入数据流
    Input["时间序列输入<br/>(B, seq_len, n_vars)"] --> Norm["StandardNorm<br/>标准化"]
    
    %% Patch Embedding 分支
    Norm --> PatchChoice{Patch Embedding<br/>选择}
    PatchChoice -->|原版| PatchEmb["PatchEmbedding<br/>(patch_len, stride)"]
    PatchChoice -->|Haar小波| WaveletEmb["WaveletPatchEmbedding<br/>(Haar + SoftThreshold)"]
    PatchChoice -->|WIST-PE| WISTEmb["WISTPatchEmbedding<br/>(因果小波 + 门控融合)"]
    
    %% 统一到 Patch 输出
    PatchEmb --> PatchOut["Patch输出<br/>(B, n_vars, d_model, patch_nums)"]
    WaveletEmb --> PatchOut
    WISTEmb --> PatchOut
    
    %% LLM 处理
    PatchOut --> Reprogram["ReprogrammingLayer<br/>(Cross-Attention)"]
    
    %% Prompt 生成
    Norm --> PromptGen["Prompt生成器"]
    PromptGen --> PromptChoice{小波Prompt<br/>增强}
    PromptChoice -->|关闭| BasicPrompt["基础统计Prompt<br/>(min/max/trend/lags)"]
    PromptChoice -->|启用| WaveletPrompt["小波特征Prompt<br/>(HFER/波动性/平滑度)"]
    
    BasicPrompt --> LLMInput["LLM输入<br/>(Prompt + Patch Embeddings)"]
    WaveletPrompt --> LLMInput
    Reprogram --> LLMInput
    
    %% LLM 主干
    LLMInput --> LLM["大语言模型<br/>(LLAMA/GPT2/BERT)"]
    LLM --> LLMOut["LLM输出<br/>(B, n_vars, d_ff, patch_nums)"]
    
    %% 输出头选择
    LLMOut --> HeadChoice{输出头选择}
    
    %% 原版 FlattenHead
    HeadChoice -->|原版| FlattenHead["FlattenHead<br/>Flatten + Linear"]
    FlattenHead --> FlattenOut["预测输出<br/>(B, pred_len, n_vars)"]
    
    %% 双尺度残差头 (当前GAP方案)
    HeadChoice -->|双尺度| DualScale["DualScaleResidualHead"]
    
    %% DualScale 内部结构 (当前GAP)
    subgraph DualScaleGAP ["双尺度头 - 当前GAP方案"]
        DSInput["输入<br/>(B, n_vars, d_ff, patch_nums)"]
        DSInput --> TrendBranch["趋势分支"]
        DSInput --> DetailBranch["细节分支"]
        
        TrendBranch --> GAP["Global Average Pooling<br/>x.mean(dim=-1)"]
        GAP --> TrendLinear["Linear(d_ff → pred_len)"]
        TrendLinear --> TrendPred["趋势预测"]
        
        DetailBranch --> Flatten["Flatten<br/>(d_ff × patch_nums)"]
        Flatten --> DetailLinear["Linear(nf → pred_len)"]
        DetailLinear --> DetailPred["细节预测"]
        
        TrendPred --> Residual["残差融合<br/>Trend + Detail"]
        DetailPred --> Residual
        Residual --> DSOutput["输出<br/>(B, pred_len, n_vars)"]
    end
    
    %% 新设计：1D深度卷积池化方案
    HeadChoice -->|新方案| DepthConvHead["1D深度卷积池化头"]
    
    subgraph DepthConvPool ["1D深度卷积池化 - 新架构方案"]
        DCInput["输入<br/>(B, n_vars, d_ff, patch_nums)"]
        
        %% 多尺度深度卷积池化分支
        DCInput --> MultiScale["多尺度深度卷积池化"]
        
        subgraph MultiScaleBranches ["多尺度分支"]
            MultiScale --> Branch1["分支1: 局部感受野"]
            MultiScale --> Branch2["分支2: 中等感受野"] 
            MultiScale --> Branch3["分支3: 全局感受野"]
            
            Branch1 --> DepthConv1["DepthwiseConv1d<br/>kernel=3, groups=d_ff"]
            Branch2 --> DepthConv2["DepthwiseConv1d<br/>kernel=5, groups=d_ff"]
            Branch3 --> DepthConv3["DepthwiseConv1d<br/>kernel=7, groups=d_ff"]
            
            DepthConv1 --> AdaptPool1["AdaptiveAvgPool1d<br/>output_size=1"]
            DepthConv2 --> AdaptPool2["AdaptiveAvgPool1d<br/>output_size=1"]
            DepthConv3 --> AdaptPool3["AdaptiveAvgPool1d<br/>output_size=1"]
            
            AdaptPool1 --> Squeeze1["Squeeze → (B, n_vars, d_ff)"]
            AdaptPool2 --> Squeeze2["Squeeze → (B, n_vars, d_ff)"]
            AdaptPool3 --> Squeeze3["Squeeze → (B, n_vars, d_ff)"]
        end
        
        %% 特征融合
        Squeeze1 --> FeatureFusion["特征融合层"]
        Squeeze2 --> FeatureFusion
        Squeeze3 --> FeatureFusion
        
        FeatureFusion --> Attention["通道注意力<br/>SE-Block"]
        Attention --> FusedFeature["融合特征<br/>(B, n_vars, d_ff)"]
        
        %% 趋势预测分支
        FusedFeature --> TrendHead["趋势预测头<br/>Linear(d_ff → pred_len)"]
        TrendHead --> TrendOut["趋势输出"]
        
        %% 细节预测分支 (保持原有)
        DCInput --> DetailFlatten["Flatten<br/>(d_ff × patch_nums)"]
        DetailFlatten --> DetailHead["细节预测头<br/>Linear(nf → pred_len)"]
        DetailHead --> DetailOut["细节输出"]
        
        %% 最终融合
        TrendOut --> FinalFusion["残差融合<br/>Enhanced_Trend + Detail"]
        DetailOut --> FinalFusion
        FinalFusion --> DCOutput["输出<br/>(B, pred_len, n_vars)"]
    end
    
    %% 三频带解耦头
    HeadChoice -->|三频带| TriBandHead["TriBandDecoupledHead"]
    
    subgraph TriBand ["三频带解耦头"]
        TBInput["输入<br/>(B, n_vars, nf)"]
        TBInput --> LowFreq["低频头<br/>Linear(nf → pred_len)"]
        TBInput --> MidFreq["中频头<br/>Linear + Dropout"]
        TBInput --> HighFreq["高频头<br/>Linear + SoftThreshold + Dropout"]
        
        LowFreq --> TBFusion["频域融合<br/>Low + Mid + High"]
        MidFreq --> TBFusion
        HighFreq --> TBFusion
        TBFusion --> TBOutput["输出<br/>(B, pred_len, n_vars)"]
    end
    
    %% 输出汇总
    FlattenOut --> FinalOut["最终预测输出<br/>(B, pred_len, n_vars)"]
    DSOutput --> FinalOut
    DCOutput --> FinalOut
    TBOutput --> FinalOut
    
    %% 后处理
    FinalOut --> Denorm["StandardNorm<br/>反标准化"]
    Denorm --> Output["预测结果<br/>(B, pred_len, n_vars)"]
    
    %% 损失计算 (可选深度监督)
    TBOutput --> DeepSupervision{深度监督损失}
    DeepSupervision -->|启用| WaveletLoss["小波分解GT<br/>+ 分量监督"]
    DeepSupervision -->|关闭| MSELoss["标准MSE损失"]
    
    %% 样式定义
    classDef inputNode fill:#e1f5fe
    classDef processNode fill:#f3e5f5
    classDef outputNode fill:#e8f5e8
    classDef newNode fill:#fff3e0
    classDef choiceNode fill:#fce4ec
    
    class Input,Norm inputNode
    class PatchEmb,WaveletEmb,WISTEmb,Reprogram,LLM processNode
    class Output,FinalOut outputNode
    class DepthConvHead,MultiScale,FeatureFusion,Attention newNode
    class PatchChoice,PromptChoice,HeadChoice,DeepSupervision choiceNode