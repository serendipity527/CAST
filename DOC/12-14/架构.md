æˆ‘å…ˆè¯»å–å…³é”®æ–‡ä»¶æ¥åˆ†æå½“å‰æ¶æ„ã€‚

åŸºäºå¯¹ä»£ç çš„å®Œæ•´åˆ†æï¼Œæˆ‘ä¸ºä½ ç»˜åˆ¶äº†å½“å‰ **TimeLLM + WIST-PE** æ¶æ„çš„ Mermaid å›¾ã€‚

---

## å½“å‰æ¶æ„åˆ†æ

### æ•´ä½“æ•°æ®æµ

```mermaid
flowchart TB
    subgraph Input["ğŸ“¥ è¾“å…¥å±‚"]
        X["x_enc<br/>(B, T, N)<br/>åŸå§‹æ—¶åº"]
    end

    subgraph Normalize["ğŸ”„ å½’ä¸€åŒ–"]
        NORM["Normalize<br/>RevIN å¯é€†å½’ä¸€åŒ–"]
    end

    subgraph Statistics["ğŸ“Š ç»Ÿè®¡ç‰¹å¾æå–"]
        STATS["è®¡ç®—ç»Ÿè®¡é‡"]
        MIN["min_values"]
        MAX["max_values"]
        MED["medians"]
        TREND["trends (diff)"]
        LAGS["top-5 lags<br/>(FFTè‡ªç›¸å…³)"]
    end

    subgraph Prompt["ğŸ“ Prompt æ„å»º"]
        PROMPT_TEXT["æ–‡æœ¬ Prompt<br/>'Dataset: ETT...<br/>min: X, max: Y...'"]
        TOKENIZER["GPT2 Tokenizer"]
        PROMPT_EMB["Prompt Embeddings<br/>(B*N, prompt_len, 768)"]
    end

    subgraph WIST_PE["ğŸŒŠ WIST-PE å°æ³¢åµŒå…¥"]
        direction TB
        subgraph CausalSWT["å› æœå°æ³¢åˆ†è§£ CausalSWT"]
            SWT_IN["è¾“å…¥ (B, N, T)"]
            SWT_CONV["å› æœè†¨èƒ€å·ç§¯<br/>dilation=2^j"]
            SWT_OUT["ç³»æ•° (B, N, T, 2)<br/>[cA, cD]"]
        end
        
        subgraph DualPath["åŒé€šé“å¤„ç†"]
            LOW["ä½é¢‘ cA<br/>(è¶‹åŠ¿)"]
            HIGH["é«˜é¢‘ cD<br/>(ç»†èŠ‚)"]
            
            subgraph LowPath["ä½é¢‘è·¯å¾„"]
                LP_PATCH["Patching"]
                LP_CONV["CausalConv1d<br/>kernel=3"]
                LP_OUT["e_low<br/>(B*N, P, d_model)"]
            end
            
            subgraph HighPath["é«˜é¢‘è·¯å¾„"]
                HP_PATCH["Patching"]
                HP_THRESH["SoftThreshold<br/>(å¯é€‰)"]
                HP_CONV["CausalConv1d<br/>kernel=3"]
                HP_DROP["Dropout 0.1"]
                HP_OUT["e_high<br/>(B*N, P, d_model)"]
            end
        end
        
        subgraph GatedFusion["é—¨æ§èåˆ"]
            CONCAT["Concat<br/>[e_low, e_high]"]
            GATE["Gate MLP<br/>Linear + Sigmoid"]
            FUSION["output = gÂ·e_low + (1-g)Â·e_high"]
        end
    end

    subgraph Reprogram["ğŸ”€ Reprogramming Layer"]
        WORD_EMB["Word Embeddings<br/>(vocab, 768)"]
        MAPPING["Mapping Layer<br/>(vocab â†’ 1000)"]
        SOURCE_EMB["Source Embeddings<br/>(1000, 768)"]
        
        Q_PROJ["Query Projection<br/>(d_model â†’ d_ff*n_heads)"]
        K_PROJ["Key Projection<br/>(768 â†’ d_ff*n_heads)"]
        V_PROJ["Value Projection<br/>(768 â†’ d_ff*n_heads)"]
        
        ATTN["Cross-Attention<br/>Q=patches, K=V=words"]
        OUT_PROJ["Output Projection<br/>(d_ff*n_heads â†’ 768)"]
    end

    subgraph LLM["ğŸ¤– Frozen LLM (GPT2)"]
        LLM_CAT["Concat<br/>[Prompt, Patches]"]
        GPT2["GPT2 Model<br/>(6 layers, frozen)"]
        LLM_OUT["Hidden States<br/>(B*N, seq, 768)"]
    end

    subgraph Output["ğŸ“¤ è¾“å‡ºå±‚"]
        SLICE["Slice [:, :, :d_ff]"]
        RESHAPE["Reshape<br/>(B, N, d_ff, P)"]
        FLATTEN["FlattenHead<br/>Linear(d_ff*P â†’ pred_len)"]
        DENORM["Denormalize"]
        PRED["é¢„æµ‹è¾“å‡º<br/>(B, pred_len, N)"]
    end

    %% è¿æ¥
    X --> NORM
    NORM --> STATS
    STATS --> MIN & MAX & MED & TREND & LAGS
    MIN & MAX & MED & TREND & LAGS --> PROMPT_TEXT
    PROMPT_TEXT --> TOKENIZER --> PROMPT_EMB

    NORM --> SWT_IN
    SWT_IN --> SWT_CONV --> SWT_OUT
    SWT_OUT --> LOW & HIGH

    LOW --> LP_PATCH --> LP_CONV --> LP_OUT
    HIGH --> HP_PATCH --> HP_THRESH --> HP_CONV --> HP_DROP --> HP_OUT

    LP_OUT --> CONCAT
    HP_OUT --> CONCAT
    CONCAT --> GATE --> FUSION

    WORD_EMB --> MAPPING --> SOURCE_EMB
    FUSION --> Q_PROJ
    SOURCE_EMB --> K_PROJ & V_PROJ
    Q_PROJ & K_PROJ & V_PROJ --> ATTN --> OUT_PROJ

    PROMPT_EMB --> LLM_CAT
    OUT_PROJ --> LLM_CAT
    LLM_CAT --> GPT2 --> LLM_OUT

    LLM_OUT --> SLICE --> RESHAPE --> FLATTEN --> DENORM --> PRED

    %% æ ·å¼
    classDef input fill:#e1f5fe,stroke:#01579b
    classDef wavelet fill:#f3e5f5,stroke:#7b1fa2
    classDef llm fill:#fff3e0,stroke:#e65100
    classDef output fill:#e8f5e9,stroke:#2e7d32
    
    class X,NORM input
    class CausalSWT,DualPath,GatedFusion wavelet
    class LLM,GPT2 llm
    class PRED output
```

---

### æ ¸å¿ƒæ¨¡å—è¯¦è§£

```mermaid
flowchart LR
    subgraph A["CausalSWT å› æœå°æ³¢"]
        A1["è¾“å…¥ x(t)"] --> A2["å·¦ä¾§ Padding<br/>(replicate)"]
        A2 --> A3["è†¨èƒ€å·ç§¯<br/>dilation=2^j"]
        A3 --> A4["ä½é¢‘ cA"]
        A3 --> A5["é«˜é¢‘ cD"]
    end

    subgraph B["ReprogrammingLayer"]
        B1["Patch Emb<br/>(d_model)"] --> B2["Q = Linear(d_model)"]
        B3["Word Emb<br/>(768)"] --> B4["K = Linear(768)"]
        B3 --> B5["V = Linear(768)"]
        B2 & B4 & B5 --> B6["Attention<br/>softmax(QK^T/âˆšd)V"]
        B6 --> B7["Output<br/>(768)"]
    end

    subgraph C["Gate Fusion"]
        C1["e_low"] --> C3["Concat"]
        C2["e_high"] --> C3
        C3 --> C4["Linear(2d â†’ d)"]
        C4 --> C5["Sigmoid â†’ g"]
        C5 --> C6["gÂ·e_low + (1-g)Â·e_high"]
    end
```

---

### ç»´åº¦å˜åŒ–æµç¨‹

```mermaid
flowchart TD
    D1["è¾“å…¥: (B, T, N)<br/>ä¾‹: (24, 512, 7)"]
    D2["å½’ä¸€åŒ–å: (B, N, T)<br/>(24, 7, 512)"]
    D3["å°æ³¢åˆ†è§£: (B, N, T, 2)<br/>(24, 7, 512, 2)"]
    D4["Patching: (B*N, P, patch_len)<br/>(168, 63, 16)"]
    D5["Embedding: (B*N, P, d_model)<br/>(168, 63, 32)"]
    D6["Reprogram: (B*N, P, d_llm)<br/>(168, 63, 768)"]
    D7["+ Prompt: (B*N, prompt+P, 768)<br/>(168, ~100, 768)"]
    D8["GPT2 Out: (B*N, seq, 768)"]
    D9["Slice: (B*N, seq, d_ff)<br/>(168, ~100, 128)"]
    D10["Reshape: (B, N, d_ff, P)<br/>(24, 7, 128, 63)"]
    D11["Flatten: (B, N, pred_len)<br/>(24, 7, 96)"]
    D12["è¾“å‡º: (B, pred_len, N)<br/>(24, 96, 7)"]

    D1 --> D2 --> D3 --> D4 --> D5 --> D6 --> D7 --> D8 --> D9 --> D10 --> D11 --> D12
```

---

### å…³é”®è®¾è®¡æ€»ç»“

| æ¨¡å— | ä½œç”¨ | å…³é”®å‚æ•° |
|------|------|----------|
| **CausalSWT** | å…¨å±€å› æœå°æ³¢åˆ†è§£ï¼Œåˆ†ç¦»è¶‹åŠ¿ä¸ç»†èŠ‚ | `wavelet_type`, `level` |
| **åŒé€šé“æŠ•å½±** | ä½é¢‘ç›´æŠ•ï¼Œé«˜é¢‘å»å™ª+Dropout | `hf_dropout`, `use_soft_threshold` |
| **é—¨æ§èåˆ** | è‡ªé€‚åº”åŠ æƒä½é¢‘/é«˜é¢‘ | `gate_bias_init` |
| **ReprogrammingLayer** | å°†æ—¶åºç‰¹å¾"ç¿»è¯‘"ä¸ºLLMå¯ç†è§£çš„è¯­ä¹‰ | `d_model`, `n_heads` |
| **Frozen GPT2** | åˆ©ç”¨é¢„è®­ç»ƒè¯­è¨€æ¨¡å‹çš„æ¨ç†èƒ½åŠ› | `llm_layers` |